; ============================================================
; ZX Spectrum AY-3-8912 3-Channel Music Engine
;
; This is player routine dissasembly from FUXOFT FXSound1
; Analyzed and commented mainly by ChatGPT
; ChatGPT orchestration, bug fixes and debugging by covex@lowlevel.cz
; ------------------------------------------------------------
; • 3 independent AY channels (A, B, C)
; • IM 2 interrupt driven for stable timing
; • Pattern / bytecode music format
; • Shadow AY registers flushed every frame
;
; Target: ZX Spectrum 128K / +2 / +3
; Assembler: SjASMPlus
; Build: sjasmplus fxs1rut
; ============================================================

        DEVICE ZXSPECTRUM48


; ------------------------------------------------------------
; ROM & hardware equates
; ------------------------------------------------------------

ROM_ISR_EXIT   EQU 56          ; ROM interrupt return
ROM_CALL_654   EQU 654         ; ROM routine (keyboard scan / sync)

AY_REG_PORT    EQU #FFFD       ; AY register select port
AY_DATA_PORT   EQU #BFFD       ; AY data write port

IM2_VECTOR     EQU #FFF4       ; IM 2 vector entry


; ------------------------------------------------------------
; Engine RAM layout
; ------------------------------------------------------------
; AY register shadow (0–13)
; ------------------------------------------------------------

AY_SHADOW      EQU 50150       ; Shadow registers for AY

GLOBAL_VOL     EQU 50164       ; Global volume / tempo
CUR_CHANNEL    EQU 50165       ; Currently processed channel
SAVED_SP       EQU 50166       ; Saved stack pointer
TEMP_SP        EQU 50168       ; Temporary stack pointer

; ------------------------------------------------------------
; Channel pattern pointers
; ------------------------------------------------------------

CH_PTR1        EQU 50170
CH_PTR2        EQU 50172
CH_PTR3        EQU 50174

; ------------------------------------------------------------
; Song header (3 pattern start pointers)
; ------------------------------------------------------------

SONG_HEADER    EQU 51253

; ------------------------------------------------------------
; Channel structures (32 bytes each)
; ------------------------------------------------------------

CH1_STRUCT     EQU 50272
CH2_STRUCT     EQU 50292
CH3_STRUCT     EQU 50312


; ============================================================
; MAIN ENTRY — MUSIC TICK / SONG START
; ============================================================

        ORG 49152

; ------------------------------------------------------------
; MusicTick
; ------------------------------------------------------------
; Called:
; • From IM 2 interrupt
; • Or externally to start a new song
;
; Input:
;   E = song number
; ------------------------------------------------------------

MusicTick:
        CALL ROM_CALL_654      ; Let ROM do housekeeping
        LD   A,E               ; A = song number

SongEntry:
        CALL SongTable         ; Convert song ID → song data pointer
        LD   DE,SONG_HEADER    ; Destination for song header
        LD   BC,6              ; 3 words (CH A/B/C)
        LDIR                   ; Copy initial pattern pointers

        CALL StopMusic         ; Stop any previous playback
        CALL StartMusic        ; Initialise engine + IM 2
        RET


; ============================================================
; SONG TABLE
; ============================================================
; Manual song dispatch using comparisons
; This avoids a jump table and allows sparse IDs
;
; Input:
;   A = song ID
; Output:
;   HL = pointer to song data
; ============================================================

        ORG 49174

SongTable:
        CP 38
        JR NZ,.s0
        LD HL,51260
        RET
.s0:
        CP 0
        JR NZ,.s15
        LD HL,53625
        RET
.s15:
        CP 15
        JR NZ,.s22
        LD HL,54490
        RET
.s22:
        CP 22
        JR NZ,.s21
        LD HL,55220
        RET
.s21:
        CP 21
        JR NZ,.s14
        LD HL,55765
        RET
.s14:
        CP 14
        JR NZ,.s6
        LD HL,57010
        RET
.s6:
        CP 6
        JR NZ,.s1
        LD HL,57675
        RET
.s1:
        CP 1
        JR NZ,.s18
        LD HL,59540
        RET
.s18:
        CP 18
        JR NZ,.s9
        LD HL,60465
        RET
.s9:
        CP 9
        JR NZ,.no_song
        LD HL,61070
        RET

.no_song:
        POP DE                 ; Invalid ID → resume playback
        JP UpdateAllChannels


; ============================================================
; DEFAULT SONG ENTRY (USED BY GAME)
; ============================================================

        ORG 49500

DefaultSong:
        LD A,38                ; Default song ID
        JP SongEntry


; ============================================================
; ENGINE ENTRY POINTS
; ============================================================

        ORG 50000
StartMusic:
        JP InitEngine

        ORG 50003
StopMusic:
        JP StopEngine


; ============================================================
; ENGINE INITIALISATION
; ============================================================
; • Copies song pointers
; • Clears channel state
; • Sets up IM 2 interrupt
; • Prepares AY shadow registers
; ============================================================

        ORG 50009

InitEngine:
        DI

        ; --------------------------------------------
        ; Load initial pattern pointers for channels
        ; --------------------------------------------

        LD HL,(SONG_HEADER)
        LD (CH1_STRUCT),HL
        LD HL,(SONG_HEADER+2)
        LD (CH2_STRUCT),HL
        LD HL,(SONG_HEADER+4)
        LD (CH3_STRUCT),HL

        ; --------------------------------------------
        ; Enable channels
        ; --------------------------------------------

        LD A,1
        LD (CH1_STRUCT+2),A
        LD (CH2_STRUCT+2),A
        LD (CH3_STRUCT+2),A

        ; --------------------------------------------
        ; Initial note duration
        ; --------------------------------------------

        LD A,8
        LD (CH1_STRUCT+3),A
        LD (CH2_STRUCT+3),A
        LD (CH3_STRUCT+3),A

        ; --------------------------------------------
        ; Pattern pointer bases
        ; --------------------------------------------

        LD HL,50208
        LD DE,32
        LD (CH_PTR1),HL
        ADD HL,DE
        LD (CH_PTR2),HL
        ADD HL,DE
        LD (CH_PTR3),HL

        ; --------------------------------------------
        ; Clear pitch accumulators and counters
        ; --------------------------------------------

        LD HL,0
        LD (CH1_STRUCT+14),HL
        LD (CH2_STRUCT+14),HL
        LD (CH3_STRUCT+14),HL
        LD (CH1_STRUCT+16),HL
        LD (CH2_STRUCT+16),HL
        LD (CH3_STRUCT+16),HL

        XOR A
        LD (GLOBAL_VOL),A

        ; --------------------------------------------
        ; IM 2 setup
        ; --------------------------------------------

        LD A,57
        LD I,A                 ; Vector page = #39xx

        LD A,24
        LD (#FFFF),A           ; Safe padding

        LD A,#C3               ; JP opcode
        LD (IM2_VECTOR),A
        LD HL,MusicISR
        LD (IM2_VECTOR+1),HL

        IM 2
        EI
        RET


; ============================================================
; IM 2 INTERRUPT SERVICE ROUTINE
; ============================================================
; Called every frame (~50Hz PAL)
; ============================================================

        ORG 50116

MusicISR:
        DI
        PUSH AF
        PUSH BC
        PUSH DE
        PUSH HL
        PUSH IX

        CALL MusicTick         ; One music tick

        POP IX
        POP HL
        POP DE
        POP BC
        POP AF
        JP ROM_ISR_EXIT


; ============================================================
; STOP MUSIC ENGINE
; ============================================================

        ORG 50135

StopEngine:
        DI
        IM 1                   ; Restore ROM interrupts
        LD A,255
        LD D,7
        CALL AY_WriteShadow
        CALL AY_Flush
        EI
        RET


        ORG 50150

AY_SHADOW_DATA:
        DB 75,0,0,0,72,15,0,255
        DB 0,0,11,0,0,0,0,3
        DB 33,156,92,196,32,196,64,196
        DB 92,196,0,0,0,0,0,0
        DB 0,0,148,199,28,216,215,199
        DB 181,198,241,215,254,1,181,198
        DB 148,199,148,199,129,241,181,198
        DB 181,198,0,0,0,0,0,0
        DB 0,0,0,0,0,0,148,199
        DB 28,216,215,199,181,198,148,199
        DB 98,234,181,198,236,239,233,239
        DB 181,198,0,0,0,0,0,0
        DB 0,0,0,0,0,0,148,199
        DB 181,198,157,200,148,199,13,235
        DB 181,198,215,199,181,198,114,206
        DB 230,38,94,200,47,8,101,209
        DB 1,75,0,0,77,209,88,208
        DB 0,0,87,208,70,15,3,205
        DB 47,8,98,208,2,0,0,14
        DB 94,208,122,208,0,0,122,208
        DB 81,8,116,206,15,8,104,208
        DB 190,72,15,11,94,208,74,209
        DB 0,0,72,209,2,4,191,15
        DB 220,14,7,14,61,13,127,12
        DB 204,11,34,11,130,10,235,9
        DB 93,9,214,8,87,8,223,7
        DB 110,7,3,7,159,6,64,6
        DB 230,5,145,5,65,5,246,4
        DB 174,4,107,4,44,4,240,3
        DB 183,3,130,3,79,3,32,3
        DB 243,2,200,2,161,2,123,2
        DB 87,2,54,2,22,2,248,1
        DB 220,1,193,1,168,1,144,1
        DB 121,1,100,1,80,1,61,1
        DB 44,1,27,1,11,1,252,0
        DB 238,0,224,0,212,0,200,0
        DB 189,0,178,0,168,0,159,0
        DB 150,0,141,0,133,0,126,0
        DB 119,0,112,0,106,0,100,0
        DB 94,0,89,0,84,0,79,0
        DB 75,0,71,0,67,0,63,0
        DB 59,0,56,0,53,0,50,0
        DB 47,0,45,0,42,0,40,0
        DB 37,0,35,0,33,0

; ============================================================
; UPDATE ALL CHANNELS (PER INTERRUPT)
; ============================================================

        ORG 50500

UpdateAllChannels:
        LD IX,CH1_STRUCT
        LD HL,(CH_PTR1)
        LD A,1
        CALL ChannelTick
        LD (CH_PTR1),HL

        LD IX,CH2_STRUCT
        LD HL,(CH_PTR2)
        LD A,2
        CALL ChannelTick
        LD (CH_PTR2),HL

        LD IX,CH3_STRUCT
        LD HL,(CH_PTR3)
        LD A,3
        CALL ChannelTick
        LD (CH_PTR3),HL

; set channels that should play
        LD A,(CH3_STRUCT + 3)
        RLCA
        LD B,A
        LD A,(CH2_STRUCT + 3)
        OR B
        RLCA
        LD B,A
        LD A,(CH1_STRUCT + 3)
        OR B
        LD D,7
        CALL AY_WriteShadow

; ============================================================
; AY FLUSH — WRITE ALL REGISTERS TO CHIP
; ============================================================

AY_Flush:
        LD D,13
        LD HL,AY_SHADOW+13
.loop:
        LD A,D
        LD BC,AY_REG_PORT
        OUT (C),A
        LD A,(HL)
        LD B,191
        OUT (C),A
        DEC HL
        DEC D
        JP P,.loop
        RET


; ============================================================
; AY SHADOW REGISTER WRITE
; ============================================================
; Input:
;   D = AY register number
;   A = value
; ============================================================

        ORG 50587

AY_WriteShadow:
        LD BC,AY_SHADOW
        LD L,D
        LD H,0
        ADD HL,BC
        LD (HL),A
        RET

; ============================================================
; CHANNEL TICK — CORE BYTECODE INTERPRETER
; ============================================================

; ============================================================
; CHANNEL TICK — SYMBOL DEFINITIONS
; ============================================================


; ------------------------------------------------------------
; Frequency table (note → period)
; ------------------------------------------------------------

FREQ_TABLE     EQU 50332        ; 16-bit AY periods

; ------------------------------------------------------------
; Channel structure layout (IX-based)
; ------------------------------------------------------------
; Offsets inferred from original code
; ------------------------------------------------------------

CH_RET_L       EQU 0            ; return address (L)
CH_RET_H       EQU 1            ; return address (H)

CH_NOTE_LEN    EQU 2            ; note duration counter
CH_VOL         EQU 3            ; channel volume

CH_PAT_L       EQU 4            ; pattern pointer (L)
CH_PAT_H       EQU 5            ; pattern pointer (H)

CH_TICK        EQU 6            ; tick countdown

CH_FREQ_L      EQU 7            ; current frequency (L)
CH_FREQ_H      EQU 8            ; current frequency (H)

CH_NOTE        EQU 9            ; note number

CH_INST_L      EQU 10           ; instrument pointer (L)
CH_INST_H      EQU 11           ; instrument pointer (H)

CH_PITCH_L     EQU 12           ; pitch stream pointer (L)
CH_PITCH_H     EQU 13           ; pitch stream pointer (H)

CH_FLAGS       EQU 14           ; flags byte

CH_TRANSPOSE   EQU 15           ; transpose amount

CH_BASE_L      EQU 16           ; pitch base pointer (L)
CH_BASE_H      EQU 17           ; pitch base pointer (H)

CH_SLIDE_ACC   EQU 18           ; slide accumulator


; ------------------------------------------------------------
; Channel flag bits (CH_FLAGS)
; ------------------------------------------------------------

FLAG_NOTE_ON   EQU 0
FLAG_INST_ON   EQU 1
FLAG_NEW_NOTE  EQU 2
FLAG_SLIDE     EQU 3


        ORG 50596

; ------------------------------------------------------------
; Stack restore helper
; ------------------------------------------------------------

Channel_SP_Restore:
        LD (TEMP_SP),SP
        LD HL,(TEMP_SP)
        LD SP,(SAVED_SP)
        RET


; ============================================================
; CHANNEL INTERPRETER ENTRY
; ============================================================
; Core engine:
; • Decodes pattern bytecode
; • Handles notes, envelopes, effects
; • Updates AY shadow registers

        ORG 50608

; ------------------------------------------------------------
; ChannelTick entry
; ------------------------------------------------------------

ChannelTick:
        LD (SAVED_SP),SP
        LD SP,HL
        LD (CUR_CHANNEL),A

        DEC (IX+2)
        JP Z,Chan_NextEvent


; ------------------------------------------------------------
; Tick countdown
; ------------------------------------------------------------

Chan_Tick:
        DEC (IX+6)
        JR NZ,Chan_UpdatePitch


; ------------------------------------------------------------
; Pattern fetch
; ------------------------------------------------------------

Fetch_Pattern:
        LD L,(IX+4)
        LD H,(IX+5)

Fetch_Byte:
        LD A,(HL)
        CP 128
        JR NZ,Check_Note

        INC HL
        LD E,(HL)
        INC HL
        LD D,(HL)
        LD (IX+4),E
        LD (IX+5),D
        JR Fetch_Pattern

; ------------------------------------------------------------
; Note / duration decode
; ------------------------------------------------------------

Check_Note:
        CP 30
        JR C,Short_Note

        SUB 50
        LD (IX+9),A
        LD (IX+6),1
        INC HL
        JR Store_Ptr

Short_Note:
        LD (IX+9),A
        INC HL
        LD A,(HL)
        LD (IX+6),A
        INC HL

Store_Ptr:
        LD (IX+4),L
        LD (IX+5),H

; ------------------------------------------------------------
; Pitch update
; ------------------------------------------------------------

Chan_UpdatePitch:
        LD A,(IX+7)
        OR (IX+8)
        JP Z,Chan_Output

        BIT 2,(IX+14)
        JP NZ,Chan_Output

        LD L,(IX+12)
        LD H,(IX+13)


; ------------------------------------------------------------
; Pitch stream interpreter
; ------------------------------------------------------------

Pitch_Stream:
        LD A,(HL)
        INC HL
        LD (IX+12),L
        LD (IX+13),H

        CP 128
        JR NZ,Pitch_130

        LD A,(HL)
        INC HL
        LD H,(HL)
        LD L,A
        JR Pitch_Stream


Pitch_130:
        CP 130
        JP NZ,Pitch_131
        SET 3,(IX+14)
        JP Pitch_Stream

Pitch_131:
        CP 131
        JP NZ,Pitch_132
        RES 3,(IX+14)
        JP Pitch_Stream

Pitch_132:
        CP 132
        JP NZ,Pitch_Apply
        LD A,9
        XOR (IX+3)
        LD (IX+3),A
        JP Pitch_Stream


; ------------------------------------------------------------
; Pitch calculation
; ------------------------------------------------------------

Pitch_Apply:
        BIT 3,(IX+14)
        JP Z,Pitch_Slide

        ADD A,(IX+18)
        LD (IX+18),A
        DEC A
        ADD A,A
        LD E,A
        LD D,0
        LD HL,FREQ_TABLE
        ADD HL,DE
        LD A,(HL)
        LD (IX+7),A
        INC HL
        LD A,(HL)
        LD (IX+8),A
        JP Chan_Output


Pitch_Slide:
        LD E,A
        LD D,0
        LD L,(IX+7)
        LD H,(IX+8)
        AND 128
        JP Z,Slide_Add
        LD D,255

Slide_Add:
        ADD HL,DE
        LD (IX+7),L
        LD (IX+8),H


; ------------------------------------------------------------
; AY output
; ------------------------------------------------------------

Chan_Output:
        LD A,(GLOBAL_VOL)
        LD D,6
        CALL AY_WriteShadow

        RES 2,(IX+14)

        LD A,(CUR_CHANNEL)
        ADD A,7
        LD D,A
        LD A,(IX+7)
        OR (IX+8)
        JR Z,No_Note
        LD A,(IX+9)

No_Note:
        CALL AY_WriteShadow

        LD A,(CUR_CHANNEL)
        DEC A
        ADD A,A
        LD D,A
        LD A,(IX+7)
        CALL AY_WriteShadow

        INC D
        LD A,(IX+8)
        CALL AY_WriteShadow

        JP Channel_SP_Restore


	ORG 50872

; ------------------------------------------------------------
; Save pattern pointer
; ------------------------------------------------------------

Save_Ptr:
        LD (IX+0),L
        LD (IX+1),H
        RET


        ORG 50879

; ------------------------------------------------------------
; New event / command
; ------------------------------------------------------------

Chan_NextEvent:
        LD L,(IX+0)
        LD H,(IX+1)

        LD A,(HL)
        INC HL
        CALL Save_Ptr

        BIT 7,A
        JP NZ,Command_Dispatch

        LD (TEMP_SP),HL
        OR A
        JR Z,Zero_Note

; ------------------------------------------------------------
; Start note
; ------------------------------------------------------------

        ADD A,(IX+15)
        LD (IX+18),A
        RES 3,(IX+14)

        DEC A
        ADD A,A
        LD E,A
        LD D,0
        LD HL,FREQ_TABLE
        ADD HL,DE
        LD E,(HL)
        INC HL
        LD D,(HL)

        LD HL,(TEMP_SP)
        JR Note_Duration

Zero_Note:
        LD DE,0

; ------------------------------------------------------------
; Duration + setup
; ------------------------------------------------------------

Note_Duration:
        LD A,(HL)
        INC HL
        CALL Save_Ptr

        LD (IX+2),A
        LD (IX+7),E
        LD (IX+8),D

        LD A,(IX+16)
        LD (IX+12),A
        LD A,(IX+17)
        LD (IX+13),A

        SET 2,(IX+14)

        BIT 1,(IX+14)
        JP NZ,Chan_Tick

        BIT 0,(IX+14)
        JP Z,Load_Instrument
        SET 1,(IX+14)


; ------------------------------------------------------------
; Instrument load
; ------------------------------------------------------------

Load_Instrument:
        LD C,(IX+10)
        LD B,(IX+11)
        LD A,(BC)
        LD (IX+9),A
        INC BC
        LD A,(BC)
        INC BC
        LD (IX+6),A
        LD (IX+4),C
        LD (IX+5),B
        JP Chan_Output


; ------------------------------------------------------------
; Command dispatch
; ------------------------------------------------------------

Command_Dispatch:
        AND 127
        LD (TEMP_SP),HL
        ADD A,A
        LD E,A
        LD D,0
        LD HL,Command_Table
        ADD HL,DE
        LD A,(HL)
        INC HL
        LD H,(HL)
        LD L,A
        PUSH HL
        LD HL,(TEMP_SP)
        RET



; ============================================================
; COMMAND JUMP TABLE
; ============================================================
; Used by Command_Dispatch
; Must be at ORG 51026
; ============================================================

        ORG 51026

Command_Table:
        DW Cmd_SetPtr           ; 51056
        DW Cmd_SetPtrPush       ; 51068
        DW Cmd_LoopStart        ; 51082
        DW Cmd_LoopEnd          ; 51092
        DW Cmd_SetTempo         ; 51110
        DW Cmd_SetVolume        ; 51121
        DW Cmd_SetPitchBase     ; 51166
        DW Cmd_SetInstrument    ; 51132
        DW Cmd_SetTranspose     ; 51148
        DW Cmd_Return           ; 51159
        DW Cmd_FlagsOn          ; 51182
        DW Cmd_FlagsOff         ; 51196
        DW Cmd_CallSub          ; 51210
        DW Cmd_AdjustGlobVolume ; 51223
        DW Cmd_RelTranspose     ; 51239

; ============================================================
; COMMAND ROUTINES
; ============================================================

        ORG 51056

Cmd_SetPtr:
        LD A,(HL)
        LD (IX+0),A
        INC HL
        LD A,(HL)
        LD (IX+1),A
        JP Chan_NextEvent


Cmd_SetPtrPush:
        LD A,(HL)
        LD (IX+0),A
        INC HL
        LD A,(HL)
        LD (IX+1),A
        INC HL
        PUSH HL
        JP Chan_NextEvent


Cmd_LoopStart:
        LD B,(HL)
        PUSH BC
        INC HL
        PUSH HL
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_LoopEnd:
        POP DE
        POP BC
        DJNZ Cmd_LoopContinue
        JP Chan_NextEvent

Cmd_LoopContinue:
        PUSH BC
        PUSH DE
        LD (IX+0),E
        LD (IX+1),D
        JP Chan_NextEvent


Cmd_SetTempo:
        LD A,(HL)
        INC HL
        LD (GLOBAL_VOL),A
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_SetVolume:
        LD A,(HL)
        INC HL
        CALL Save_Ptr
        LD (IX+3),A
        JP Chan_NextEvent


Cmd_SetInstrument:
        LD A,(HL)
        LD (IX+10),A
        INC HL
        LD A,(HL)
        LD (IX+11),A
        INC HL
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_SetTranspose:
        LD A,(HL)
        INC HL
        CALL Save_Ptr
        LD (IX+15),A
        JP Chan_NextEvent


Cmd_Return:
        POP HL
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_SetPitchBase:
        LD A,(HL)
        LD (IX+16),A
        INC HL
        LD A,(HL)
        LD (IX+17),A
        INC HL
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_FlagsOn:
        SET 0,(IX+14)
        RES 1,(IX+14)
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_FlagsOff:
        RES 0,(IX+14)
        RES 1,(IX+14)
        CALL Save_Ptr
        JP Chan_NextEvent


Cmd_CallSub:
        LD E,(HL)
        INC HL
        LD D,(HL)
        INC HL
        CALL Save_Ptr
        LD BC,Chan_NextEvent
        PUSH BC
        PUSH DE
        RET

Cmd_AdjustGlobVolume:
        LD A,(GLOBAL_VOL)
        ADD A,(HL)
        AND 15
        LD (GLOBAL_VOL),A
        INC HL
        CALL Save_Ptr
        JP Chan_NextEvent

Cmd_RelTranspose:
        LD A,(HL)
        ADD A,(IX+15)
        LD (IX+15),A
        INC HL
        CALL Save_Ptr
        JP Chan_NextEvent


;  song data should start at 51260


; ============================================================
; IM 2 VECTOR TABLE - not saved, generated by the code to set IM 2
; ============================================================

        ORG #FFFC
        DB #C3
        DW MusicISR
        DB 0

	SAVETAP "fxs1rut.tap", CODE,"fxs1rut",49152,51260-49152
